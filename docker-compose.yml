services:
    app:
        build:
            context: .
            dockerfile: Dockerfile
        ports:
            - '${APP_PORT:-8080}:80'
        environment:
            APP_ENV: ${APP_ENV:-dev}
            APP_SECRET: ${APP_SECRET:-change_me_in_production}
            DATABASE_URL: 'pdo-pgsql://app:secret@database:5432/app?serverVersion=16&charset=utf8'
        volumes:
            - '.:/var/www/html'
        networks:
            - app-network
        depends_on:
            database:
                condition: service_healthy

    database:
        image: postgres:16-alpine
        environment:
            POSTGRES_USER: app
            POSTGRES_PASSWORD: secret
            POSTGRES_DB: app
        ports:
            - '${DB_PORT:-5432}:5432'
        volumes:
            - db-data:/var/lib/postgresql/data
        networks:
            - app-network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U app -d app"]
            interval: 5s
            timeout: 5s
            retries: 5

networks:
    app-network:
        driver: bridge

volumes:
    db-data:
        driver: local
